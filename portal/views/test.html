<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Home</title>
	<link rel="stylesheet" type="text/css" href="css/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="css/color.css">
	<link rel="stylesheet" type="text/css" href="css/icon.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script type="text/javascript" src="lib/jquery.min.js"></script>
	<script type="text/javascript" src="lib/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="lib/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="lib/sc_clock.js"></script>
</head>
<body>	
	<div style="margin-top:6px;padding:5px;">
	用户名：<%= user.username %>
	编号：<%= user.index %>
	机器密码：<%= user.code %>
	<span style="font-size:16px;padding:5px;">当前时间：</span>
	<input class="easyui-textbox" type="text" id="currTime" style="width:130px;height:20px;padding:5px;" data-options="readonly:true"></input>
	<a id="quit" class="btn" href="/logout">退出</a>	
	</div>
	<div class="easyui-panel" id="container" title="控制器" style="padding:5px;width:100%;">
		<style>.panel-title{font-size:16px}</style>	
		<table id="ctltable">
			<tbody>
			<td>
				<div class="easyui-panel c2" id="p-28" title="未使用"
					data-options="footer:'#footer-28',closed:false, tools:[{iconCls:'icon-edit',handler:modifyName},
							{iconCls:'icon-reload',handler:reloadData}]">
					<a href="#" class="easyui-linkbutton c6">20 充 20W</a>
					<a href="#" class="easyui-linkbutton c6"">20 放 20W</a>
					<a href="#" class="easyui-linkbutton c6"">故障 12</a>
					<a href="#" class="easyui-linkbutton"data-options="iconCls:'icon-redo',disabled:true">进入</a>
					<div class="temperature" >
						<span class="temptext">
							流量/温度:10000 20000 -50.5℃
						</span>
					</div>
				</div>
				<div class="footer" id="footer-28">
					未连接.
				</div>
			</td>
			<tbody>			
		</table>
	</div>	
	<div id="w" class="easyui-dialog" title="添加名称" closed="true" style="text-align:center;width:200px;height:110px;padding:5px;">		
		<style>.panel-title{font-size:12px}</style>	
		<div style="margin-top:6px">
			<span style="font-size:12px;">名称：</span>
			<input class="easyui-textbox" type="text" id="cname" name="cname" style="width:100px;height:20px;padding:5px" data-options="required:true,prompt:'名称'">
		</div>		
		<div style="margin-top:7px">
			<a href="#" id="setName" class="easyui-linkbutton" data-options="iconCls:'icon-ok'">确定</a>
			
		</div>
	</div>
</body>
<script type="text/javascript">

function createCtl(){
	var tr = $('<tr />'),
	td = $('<td />'),
	div = $('<div />');
	td.attr("id","t_0");
	$("td").css("width","160px");
	$("td").css("padding","10px");
	div.attr("class","easyui-panel c2");
	div.attr("id","p_0");
	div.attr("title","未使用");
}

function modifyName(){
	var d = $('#p-28')[0].data;
	$('#w')[0].data = d;
	$('#cname').textbox('setText',d.name);
	$('#w').window('open');
}

function reloadData(){
	var d = $('#p-28')[0].data;
	$('#container')[0].data = d;
	refreshCtl();
}

function loadSystemTime() { 

	$.get('/getTime?ts:'+new Date(), {}, function(data){ 
		if (window.scClock) 
			window.scClock.updateTime(data);
	}); 
	setTimeout("loadSystemTime()", 60000*15); 
} 

function startupClock() { 
	if (window.scClock) { 
		window.scClock.startup(function(time){ 
			$("#currTime").text(time); 
			$("#currTime").textbox('setText',time);
		}); 
	} 
}

loadSystemTime();
startupClock();

var l = window.location.href.split('/'),
	url = 'http://' + l[2];
var socket = io.connect(url+':8080');

socket.on('connect', function (argument) {
    console.log('!!!!connected.');
});

socket.on('onCtlRegistered', function (data) {
    console.log('onCtlRegistered...',data);
    if(data.index === "<%= user.index %>" && 
    	data.code === "<%= user.code %>"){
	    var a=document.getElementById("ctltable").getElementsByTagName("td");
	    for(var i in a){
	    	if(!$("#p-"+i)[0].data){
	    		console.log('#####None used panel!!!p-',i);
	    		$("#p-"+i).panel({title:data.name + ":" + data.cid + "/0"});
				$("#p-"+i)[0].data = data;
				$("#p-"+i)[0].data.pid = "p-" + i;
				$("#p-"+i)[0].data.fid = "footer-" + i;
				reloadCtl($("#p-"+i)[0].data);
	    		break;
	    	}
	    }
    }
});

socket.on('disconnect', function (argument) {
    console.log('!!!!!disconnected.');
});

socket.on('onMaxCtlPowers', function (argument) {
    console.log('!!!!!onMaxCtlPowers.');
    for(var c in argument){
    	var ctl = argument[c];
	    if(String(ctl.index) === "<%= user.index %>" && 
	        String(ctl.code) === "<%= user.code %>"){
	       	var a=document.getElementById("ctltable").getElementsByTagName("td");
	       	for(var i in a){	       		
	       		if(!$("#p-"+i)[0]) continue;
	       	  	if($("#p-"+i)[0].hasOwnProperty('data') && $("#p-"+i)[0].data.cid === ctl.cid){
	       	  		console.debug('debug data!!!!' + JSON.stringify($("#p-"+i)[0].data));
	       	  		if($("#p-"+i)[0].data.state === 1){
		       			var strMaxPower = "充放功率(充/放):",
		       				maxCPower = 'NA',maxDPower = 'NA';
		       			if(ctl.hasOwnProperty('cpower') && ctl.cpower !== -1)
		       				maxCPower = ctl.cpower+'W';
		       			if(ctl.hasOwnProperty('dpower') && ctl.dpower !== -1)
		       				maxDPower = ctl.dpower+'W';
		       			strMaxPower += maxCPower + '/' + maxDPower;
		       			$("#pw-"+i).text(strMaxPower);
		       			//reloadCtl($("#p-"+i)[0].data);
	       	  		}
	       	    	break;
	       	   }
	        }
	    }
    }
});

socket.on('onUpdateData', function (argument) {
    console.log('!!!!!update data.',argument);
    if(String(argument.index) === "<%= user.index %>" && 
       	String(argument.code) === "<%= user.code %>"){
   	    var a=document.getElementById("ctltable").getElementsByTagName("td");
   	    for(var i in a){
   	    	if(!$("#p-"+i)[0]) continue;
   	    	if($("#p-"+i)[0].data && $("#p-"+i)[0].data.cid === argument.cid){
   				$("#p-"+i)[0].data.state = 1;
   				var strTraffic = "人流/车流/温度:";
   				if(argument.people !== undefined && argument.people !== -1 && 
   					argument.vehicle !== undefined && argument.vehicle !== -1 && 
   					argument.temperature !== undefined && argument.temperature !== -1)
   					strTraffic += argument.people + '/' + argument.vehicle + '/' + argument.temperature + '℃';
   				$("#t-"+i).text(strTraffic);
   				//reloadCtl($("#p-"+i)[0].data);
   	    		break;
   	    	}
   	    }
   }
});

socket.on('onCtlOnline', function (argument) {
    console.log('!!!!onCtlOnline.',argument);
    if(String(argument.index) === "<%= user.index %>" && 
    	String(argument.code) === "<%= user.code %>"){
	    var a=document.getElementById("ctltable").getElementsByTagName("td");
	    for(var i in a){
	    	if(!$("#p-"+i)[0]) continue;
	    	if($("#p-"+i)[0].data && $("#p-"+i)[0].data.cid === argument.cid){
				$("#p-"+i)[0].data.state = 1;
				var strTraffic = "人流/车流/温度:";
				if(argument.people && argument.vehicle && argument.temperature)
					strTraffic += argument.people + '/' + argument.vehicle + '/' + argument.temperature + '℃';
				$("#t-"+i).text(strTraffic);
				reloadCtl($("#p-"+i)[0].data);
	    		break;
	    	}
	    }
    }
});

socket.on('onCtlOffline', function (argument) {
    console.log('!!!!onCtlOffline.',argument);
    if(String(argument.index) === "<%= user.index %>" && 
    	String(argument.code) === "<%= user.code %>"){
	    var a=document.getElementById("ctltable").getElementsByTagName("td");
	    for(var i in a){
	    	if(!$("#p-"+i)[0]) continue;
	    	if($("#p-"+i)[0].hasOwnProperty('data') && $("#p-"+i)[0].data.cid === argument.cid){
				$("#p-"+i)[0].data.state = 0;
				$("#t-"+i).text("人流/车流/温度:");
				$("#pw-"+i).text("充放功率(充/放):");
				reloadCtl($("#p-"+i)[0].data);
	    		break;
	    	}
	    }
    }
});

function reloadCtl(ctl){
	$.post('getControllerInfo',{index:ctl.index, code:ctl.code, cid:ctl.cid}, function(data, status){
		if(data !== "failed"){
			console.debug('reloadCtl...',data);
			var pa = document.getElementById(ctl.pid);
			var libtns = pa.getElementsByClassName("easyui-linkbutton");
			libtns[3].className = "easyui-linkbutton l-btn l-btn-small";
			libtns[3].href = "/light?cid=" + data.cid;
			libtns[3].target = "_blank";
			$("#"+ctl.pid).panel({title:ctl.name+":"+ctl.cid+"/"+data.lightCount});
			var sps1 = libtns[0].getElementsByTagName("span");
			sps1[0].style.marginTop = 0;
			sps1[1].innerHTML = "充电" + data.chargeNum;
			var sps2 = libtns[1].getElementsByTagName("span");
			sps2[0].style.marginTop = 0;
			sps2[1].innerHTML = "亮灯" + data.lightNum;
			var sps3 = libtns[2].getElementsByTagName("span");
			sps3[0].style.marginTop = 0;
			sps3[1].innerHTML = "故障" + data.brokenNum;
			if(data.state === 1){
				$("#"+ctl.pid)[0].className = "easyui-panel c4";
				var cnnStr = "已连接";
				if(data.cnnTime && data.cnnTime !== -1){
					var time = new Date(data.cnnTime),
						tmp = time.toLocaleDateString().split('/'),
						h = String(time.getHours()),
						m = String(time.getMinutes());
					if(tmp.length === 1){
						//处理浏览器兼容问题，有的浏览器时间格式是用'-'分割。有的是'/'分割
						tmp = time.toLocaleDateString().split('-');
					}
					if(tmp[1].length === 1) tmp[1] = '0' + tmp[1];
					if(tmp[2].length === 1) tmp[2] = '0' + tmp[2];
					if(h.length === 1) h = '0' + h;
					if(m.length === 1) m = '0' + m;
					datetime = tmp[1] + '-' + tmp[2] + ' ' + h + ':' + m;
					cnnStr += "(" + datetime + ")";
				}
				$("#"+ctl.fid).text(cnnStr);
				if(data.chargeState === "charing"){
					libtns[0].className = "easyui-linkbutton c1 l-btn l-btn-small";
				}
				else {
					libtns[0].className = "easyui-linkbutton c2 l-btn l-btn-small";
				}
				if(data.lightState === "lighting"){				
					libtns[1].className = "easyui-linkbutton c7 l-btn l-btn-small";
				}
				else {
					libtns[1].className = "easyui-linkbutton c2 l-btn l-btn-small";
				}
				if(data.brokenState === "broken"){
					libtns[2].className = "easyui-linkbutton c5 l-btn l-btn-small";
				}
				else {
					libtns[2].className = "easyui-linkbutton c1 l-btn l-btn-small";
				}
			}
			else {
				$("#"+ctl.pid)[0].className = "easyui-panel c2";
				var cnnStr = "未连接";
				if(data.cnnTime && data.cnnTime !== -1){
					var time = new Date(data.cnnTime),
						tmp = time.toLocaleDateString().split('/'),
						h = String(time.getHours()),
						m = String(time.getMinutes());
					if(tmp.length === 1){
						//处理浏览器兼容问题，有的浏览器时间格式是用'-'分割。有的是'/'分割
						tmp = time.toLocaleDateString().split('-');
					}
					if(tmp[1].length === 1) tmp[1] = '0' + tmp[1];
					if(tmp[2].length === 1) tmp[2] = '0' + tmp[2];
					if(h.length === 1) h = '0' + h;
					if(m.length === 1) m = '0' + m;
					datetime = tmp[1] + '-' + tmp[2] + ' ' + h + ':' + m;
					cnnStr += "(最近一次：" + datetime + ")";
				}
				$("#"+ctl.fid).text(cnnStr);
				$("#"+ctl.pid).panel({title:ctl.name+":"+ctl.cid+"/"+data.lightCount});
				//libtns[3].className = "easyui-linkbutton l-btn l-btn-small l-btn-disabled";		
				//libtns[3].href = "#";
				var sps1 = libtns[0].getElementsByTagName("span");
				//sps1[0].style.marginTop = "10px";
				//sps1[1].innerHTML = "充电";
				libtns[0].className = "easyui-linkbutton c6 l-btn l-btn-small";
				var sps2 = libtns[1].getElementsByTagName("span");
				//sps2[0].style.marginTop = "10px";
				//sps2[1].innerHTML = "亮灯";
				libtns[1].className = "easyui-linkbutton c6 l-btn l-btn-small";
				var sps3 = libtns[2].getElementsByTagName("span");
				//sps3[0].style.marginTop = "10px";
				//sps3[1].innerHTML = "故障";
				libtns[2].className = "easyui-linkbutton c6 l-btn l-btn-small";
			}
		}
	});
}

function reloadAll() {
	var na = "<%= user.username %>",
		idx = "<%= user.index %>",
		co = "<%= user.code %>";
	$.post('getAllControllers',{index:idx, code:co}, function(data, status){
		return;
		if(data === 'session expired'){
			window.location = "/";
		}
		else if (data !== null && data !== undefined && data !== 'failed'){
			var a=document.getElementById("ctltable").getElementsByTagName("td");			
			for (var i=0;i<data.length;i++) {
				if(i < a.length){
					$("#p-"+i).panel({title:data[i].name + ":" + data[i].cid + "/" + data[i].lightCount});
					$("#p-"+i)[0].data = data[i];
					$("#p-"+i)[0].data.pid = "p-" + i;
					$("#p-"+i)[0].data.fid = "footer-" + i;
					var libtns = a[i].getElementsByClassName("easyui-linkbutton");
					libtns[3].className = "easyui-linkbutton l-btn l-btn-small";
					libtns[3].href = "/light?cid=" + data[i].cid;
					libtns[3].target = "_blank";
					if(data[i].chargeNum){
						var sps1 = libtns[0].getElementsByTagName("span");
						sps1[0].style.marginTop = 0;
						sps1[1].innerHTML = "充电" + data[i].chargeNum;
					}
					else {
						var sps1 = libtns[0].getElementsByTagName("span");
						sps1[0].style.marginTop = 0;
						sps1[1].innerHTML = "充电0";
					}
					if(data[i].lightNum){
						var sps2 = libtns[1].getElementsByTagName("span");
						sps2[0].style.marginTop = 0;
						sps2[1].innerHTML = "亮灯" + data[i].lightNum;
					}else {
						var sps2 = libtns[1].getElementsByTagName("span");
						sps2[0].style.marginTop = 0;
						sps2[1].innerHTML = "亮灯0";
					}					
					if(data[i].brokenNum){
						var sps3 = libtns[2].getElementsByTagName("span");
						sps3[0].style.marginTop = 0;
						sps3[1].innerHTML = "故障" + data[i].brokenNum;
					}else {
						var sps3 = libtns[2].getElementsByTagName("span");
						sps3[0].style.marginTop = 0;
						sps3[1].innerHTML = "故障0";
					}				
					if(data[i].state === 1){
						$("#p-"+i)[0].className = "easyui-panel c4";
						var cnnStr = "已连接";
						if(data[i].cnnTime && data[i].cnnTime !== -1){
							var time = new Date(data[i].cnnTime),
								tmp = time.toLocaleDateString().split('/'),
								h = String(time.getHours()),
								m = String(time.getMinutes());
							if(tmp.length === 1){
								//处理浏览器兼容问题，有的浏览器时间格式是用'-'分割。有的是'/'分割
								tmp = time.toLocaleDateString().split('-');
							}
							if(tmp[1].length === 1) tmp[1] = '0' + tmp[1];
							if(tmp[2].length === 1) tmp[2] = '0' + tmp[2];
							if(h.length === 1) h = '0' + h;
							if(m.length === 1) m = '0' + m;
							datetime = tmp[1] + '-' + tmp[2] + ' ' + h + ':' + m;
							cnnStr += "(" + datetime + ")";
						}
						$("#footer-"+i).text(cnnStr);		
						if(data[i].chargeState === "charing"){
							libtns[0].className = "easyui-linkbutton c1 l-btn l-btn-small";
						}
						else {
							libtns[0].className = "easyui-linkbutton c2 l-btn l-btn-small";
						}
						
						if(data[i].lightState === "lighting"){				
							libtns[1].className = "easyui-linkbutton c7 l-btn l-btn-small";
						}
						else {
							libtns[1].className = "easyui-linkbutton c2 l-btn l-btn-small";
						}
						
						if(data[i].brokenState === "broken"){
							libtns[2].className = "easyui-linkbutton c5 l-btn l-btn-small";
						}
						else {
							libtns[2].className = "easyui-linkbutton c1 l-btn l-btn-small";
						}
					} else {
						$("#p-"+i)[0].className = "easyui-panel c2";
						var cnnStr = "未连接";
						if(data[i].cnnTime && data[i].cnnTime !== -1){
							var time = new Date(data[i].cnnTime),
								tmp = time.toLocaleDateString().split('/'),
								h = String(time.getHours()),
								m = String(time.getMinutes());
							if(tmp.length === 1){
								//处理浏览器兼容问题，有的浏览器时间格式是用'-'分割。有的是'/'分割
								tmp = time.toLocaleDateString().split('-');
							}
							if(tmp[1].length === 1) tmp[1] = '0' + tmp[1];
							if(tmp[2].length === 1) tmp[2] = '0' + tmp[2];
							if(h.length === 1) h = '0' + h;
							if(m.length === 1) m = '0' + m;
							datetime = tmp[1] + '-' + tmp[2] + ' ' + h + ':' + m;
							cnnStr += "(最近一次：" + datetime + ")";
						}
						$("#footer-"+i).text(cnnStr);
						$("#p-"+i).panel({title:data[i].name + ":" + data[i].cid + "/" + data[i].lightCount});
						var libtns = a[i].getElementsByClassName("easyui-linkbutton");
						var sps1 = libtns[0].getElementsByTagName("span");
						//sps1[0].style.marginTop = "10px";
						//sps1[1].innerHTML = "充电";
						libtns[0].className = "easyui-linkbutton c6 l-btn l-btn-small";
						var sps2 = libtns[1].getElementsByTagName("span");
						//sps2[0].style.marginTop = "10px";
						//sps2[1].innerHTML = "亮灯";
						libtns[1].className = "easyui-linkbutton c6 l-btn l-btn-small";
						var sps3 = libtns[2].getElementsByTagName("span");
						//sps3[0].style.marginTop = "10px";
						//sps3[1].innerHTML = "故障";
						libtns[2].className = "easyui-linkbutton c6 l-btn l-btn-small";
					}
				}
			}
		}
	});
	setTimeout("reloadAll()", 10*1000);
};
$("#setName").click(function() {
	console.debug($('#w')[0].data);
	var ctl = $('#w')[0].data,
		na = $('#cname').val();
	if(!ctl || na == "") return;
	$.post('updateCtlName',{index:ctl.index,code:ctl.code,cid:ctl.cid,name:na},function(result, status){
		if(result === "success"){
			$("#"+ctl.pid).panel({title:na+":"+ctl.cid});
			$('#w').window('close');
		}
	});
});

function refreshCtl(){	
	var ctl = $('#container')[0].data;
	if(!ctl) return;
	reloadCtl(ctl);
};

window.onload = function (){
	reloadAll();	
}
</script>
</html>